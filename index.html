let allPosts = [];
let wpConnected = false;

// Toggle authentication fields
function toggleAuthFields() {
    const method = document.getElementById('authMethod').value;
    const authFields = document.getElementById('authFields');
    authFields.style.display = method === 'app_password' ? 'block' : 'none';
}

// Connect to WordPress
async function connectToWordPress() {
    const wpUrl = document.getElementById('wpUrl').value.trim();
    const authMethod = document.getElementById('authMethod').value;
    
    if (!wpUrl) {
        showStatus('wpStatus', 'error', 'Please enter your WordPress site URL');
        return;
    }
    
    showStatus('wpStatus', 'info', 'Connecting to WordPress...');
    
    try {
        const baseUrl = wpUrl.replace(/\/+$/, '');
        const apiUrl = `${baseUrl}/wp-json/wp/v2/posts?per_page=100&orderby=date&order=desc`;
        
        let headers = {};
        
        if (authMethod === 'app_password') {
            const username = document.getElementById('wpUsername').value.trim();
            const password = document.getElementById('wpPassword').value.trim();
            
            if (!username || !password) {
                showStatus('wpStatus', 'error', 'Please enter username and password');
                return;
            }
            
            const auth = btoa(`${username}:${password}`);
            headers['Authorization'] = `Basic ${auth}`;
        }
        
        const response = await fetch(apiUrl, { headers });
        
        if (!response.ok) {
            throw new Error(`HTTP ${response.status}`);
        }
        
        const posts = await response.json();
        allPosts = posts;
        wpConnected = true;
        
        displayPosts(posts);
        
        // Save settings
        localStorage.setItem('wp_url', wpUrl);
        localStorage.setItem('wp_auth_method', authMethod);
        if (authMethod === 'app_password') {
            localStorage.setItem('wp_username', document.getElementById('wpUsername').value);
        }
        
        showStatus('wpStatus', 'success', `Connected! Found ${posts.length} posts`);
        
    } catch (error) {
        console.error('WordPress connection error:', error);
        showStatus('wpStatus', 'error', 'Failed to connect. Check URL and try Public method first.');
        wpConnected = false;
    }
}

// Display posts in sidebar
function displayPosts(posts) {
    const postsList = document.getElementById('postsList');
    const postCount = document.getElementById('postCount');
    
    postCount.textContent = `${posts.length} posts`;
    
    if (posts.length === 0) {
        postsList.innerHTML = '<p style="color: #999; text-align: center;">No posts found</p>';
        return;
    }
    
    postsList.innerHTML = posts.map(post => {
        const date = new Date(post.date).toLocaleDateString();
        const title = post.title.rendered || 'Untitled';
        
        return `
            <div class="post-item" onclick="selectPost('${title.replace(/'/g, "\\'")}')">
                <div class="post-title">${title}</div>
                <div class="post-date">${date}</div>
            </div>
        `;
    }).join('');
}

// Select a post from the list
function selectPost(title) {
    document.getElementById('topic').value = title;
    checkForDuplicates();
}

// Check for duplicate posts
function checkForDuplicates() {
    const topic = document.getElementById('topic').value.trim().toLowerCase();
    
    if (!topic || !wpConnected || allPosts.length === 0) {
        document.getElementById('duplicateWarning').style.display = 'none';
        return;
    }
    
    // Find similar posts
    const similarPosts = allPosts.filter(post => {
        const postTitle = (post.title.rendered || '').toLowerCase();
        
        // Check for exact match
        if (postTitle === topic) return true;
        
        // Check if titles share significant words
        const topicWords = topic.split(' ').filter(word => word.length > 3);
        const titleWords = postTitle.split(' ').filter(word => word.length > 3);
        
        const matchingWords = topicWords.filter(word => 
            titleWords.some(titleWord => titleWord.includes(word) || word.includes(titleWord))
        );
        
        return matchingWords.length >= Math.min(2, topicWords.length * 0.5);
    });
    
    if (similarPosts.length > 0) {
        const warningDiv = document.getElementById('duplicateWarning');
        const similarPostsDiv = document.getElementById('similarPosts');
        
        warningDiv.style.display = 'block';
        
        similarPostsDiv.innerHTML = similarPosts.slice(0, 5).map(post => 
            `<div class="similar-post">â€¢ ${post.title.rendered}</div>`
        ).join('');
        
        showStatus('phase1Status', 'info', `Found ${similarPosts.length} similar post(s)`);
    } else {
        document.getElementById('duplicateWarning').style.display = 'none';
    }
}

// Switch between phases
function switchPhase(phase, event) {
    // Update tabs
    document.querySelectorAll('.phase-tab').forEach(tab => {
        tab.classList.remove('active');
    });
    event.target.classList.add('active');
    
    // Update content
    document.querySelectorAll('.phase-content').forEach(content => {
        content.classList.remove('active');
    });
    document.getElementById(phase).classList.add('active');
}

// Generate Phase 1 Prompt
function generatePhase1Prompt() {
    const topic = document.getElementById('topic').value.trim();
    const keyword = document.getElementById('keyword').value.trim();
    const searchIntent = document.getElementById('searchIntent').value.trim();
    
    if (!topic || !keyword) {
        showStatus('phase1Status', 'error', 'Please enter both topic and keyword');
        return;
    }
    
    const prompt = `# Phase 1: Billy Ribeiro Content Framework v2.0 (Google 2025 Optimized)

[YOUR FULL PROMPT CONTENT HERE - TOO LONG TO INCLUDE BUT SAME AS BEFORE]`;
    
    document.getElementById('promptOutput').value = prompt;
    document.getElementById('phase1Output').classList.add('show');
    document.getElementById('phase1Output').scrollIntoView({ behavior: 'smooth' });
    
    showStatus('phase1Status', 'success', 'Phase 1 prompt generated! Copy and paste into Claude.');
}

// Parse tagged content
function parseTaggedContent(content) {
    const tags = {};
    const regex = /\{\{([^}]+)\}\}:\s*([^{]*(?:\{[^}]*\}[^{]*)*?)(?=\{\{|$)/gs;
    let match;
    
    while ((match = regex.exec(content)) !== null) {
        const tagName = match[1].trim();
        const tagContent = match[2].trim();
        tags[tagName] = tagContent;
    }
    
    return tags;
}

// Generate slug
function generateSlug(title) {
    return title
        .toLowerCase()
        .replace(/[^\w\s-]/g, '')
        .replace(/\s+/g, '-')
        .replace(/--+/g, '-')
        .trim();
}

// Process content with H3/H4 headings
function processContentWithHeadings(content) {
    // [SAME FUNCTION AS BEFORE]
}

// Generate HTML
function generateHTML() {
    // [COMPLETE HTML GENERATION FUNCTION AS BEFORE]
}

// Copy content
function copyContent(elementId) {
    const textarea = document.getElementById(elementId);
    textarea.select();
    textarea.setSelectionRange(0, 99999);
    
    try {
        document.execCommand('copy');
        const message = elementId === 'promptOutput' ? 
            'Prompt copied! Paste into Claude.ai' : 
            'HTML copied! Paste into WordPress';
        showStatus(elementId === 'promptOutput' ? 'phase1Status' : 'phase2Status', 'success', message);
    } catch (err) {
        alert('Please select and copy manually');
    }
}

// Open Claude
function openClaude() {
    window.open('https://claude.ai', '_blank');
}

// Download HTML
function downloadHTML() {
    const html = document.getElementById('htmlOutput').value;
    const blob = new Blob([html], { type: 'text/html' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = 'blog-post.html';
    a.click();
    URL.revokeObjectURL(url);
    
    showStatus('phase2Status', 'success', 'HTML file downloaded!');
}

// Show status messages
function showStatus(elementId, type, message) {
    const statusEl = document.getElementById(elementId);
    statusEl.className = `status show ${type}`;
    statusEl.textContent = message;
    
    setTimeout(() => {
        statusEl.classList.remove('show');
    }, 5000);
}

// Load saved settings on page load
window.addEventListener('load', () => {
    const savedUrl = localStorage.getItem('wp_url');
    const savedMethod = localStorage.getItem('wp_auth_method');
    const savedUsername = localStorage.getItem('wp_username');
    
    if (savedUrl) {
        document.getElementById('wpUrl').value = savedUrl;
    }
    
    if (savedMethod) {
        document.getElementById('authMethod').value = savedMethod;
        toggleAuthFields();
    }
    
    if (savedUsername) {
        document.getElementById('wpUsername').value = savedUsername;
    }
    
    // Auto-connect if we have saved settings
    if (savedUrl) {
        setTimeout(() => {
            connectToWordPress();
        }, 1000);
    }
});
